sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/ui/model/Binding","../model/models","sap/m/MessageBox"],function(e,t,i,l,n,a,r,s,o){"use strict";let u="";return e.extend("desg.controller.Main",{onInit:async function(){this.setModelInputField();await this.fetchClientSetModel();await this.fetchMearsureSetModel();this.setModelLogarithm();this.displayData()},displayData:async function(){let e=this.getView();let t=this;let i=await s.getParameter();if(i.error){console.log(i.error)}else{let e=i.value;console.log(e);let l=e[1];let n=e[0];await t.getOverviewDataDisplay(l);await t.getClientDataDisplay("overview",l);await t.getValueDataDisplay(n);await t.getClientDataDisplay("value",n);console.log(this.getView().getModel().getData())}},getOverviewDataDisplay:function(e){let t=this.getView();let i=t.getModel("mearsureData").getData().data;let l=["objective1","objective2","subjective1","rugsub","subjective2"];for(let n in e){if(`${n}`=="usage_flag"&&`${e[n]}`=="X"){t.getModel().setProperty("/overview/status/external",true);t.getModel().setProperty("/overview/status/internal","X")}else if(`${n}`=="usage_flag"&&`${e[n]}`==""){t.getModel().setProperty("/overview/status/external",false)}if(`${n}`=="logarithm"){t.byId("input_overview_logarithm").setSelectedKey(`${e[n]}`)}if(`${n}`=="pValue"||`${n}`=="year"){t.getModel().setProperty(`/overview/${n}/internal`,`${e[n]}`)}let a=l.find(e=>e==`${n}`);if(a!=undefined){let l=i.find(t=>t.var==`${e[n]}`);if(l!=undefined){t.getModel().setProperty(`/overview/${n}/internal`,l.var);t.getModel().setProperty(`/overview/${n}/external`,l.var_name)}}}},getValueDataDisplay:function(e){let t=this.getView();let i=t.getModel("mearsureData").getData().data;let l=["objective1","objective2","subjective1","rugsub","subjective2"];for(let n in e){if(`${n}`=="usage_flag"&&`${e[n]}`=="X"){t.getModel().setProperty("/value/status/external",true);t.getModel().setProperty("/value/status/internal","X")}else if(`${n}`=="usage_flag"&&`${e[n]}`==""){t.getModel().setProperty("/value/status/external",false)}if(`${n}`=="logarithm"){t.byId("input_value_logarithm").setSelectedKey(`${e[n]}`)}if(`${n}`=="pValue"||`${n}`=="year"){t.getModel().setProperty(`/value/${n}/internal`,`${e[n]}`)}let a=l.find(e=>e==`${n}`);if(a!=undefined){let l=i.find(t=>t.var==`${e[n]}`);if(l!=undefined){t.getModel().setProperty(`/value/${n}/internal`,l.var);t.getModel().setProperty(`/value/${n}/external`,l.var_name)}}}},getClientDataDisplay:function(e,t){let i=this;if(e=="overview"){let e=i.getView().getModel("allClient").getData().data;let l=e.find(e=>e.CLIENTKEY==t.client);if(l!=undefined){i.getView().getModel().setProperty("/overview/client/internal",l.CLIENTKEY);i.getView().getModel().setProperty("/overview/client_item/internal",l.CLIENT_ITEM)}}else{let e=i.getView().getModel("allClient").getData().data;let l=e.find(e=>e.CLIENTKEY==t.client);if(l!=undefined){i.getView().getModel().setProperty("/value/client/internal",l.CLIENTKEY);i.getView().getModel().setProperty("/value/client_item/internal",l.CLIENT_ITEM)}}},onSelectCheckbox:function(e){let t=this.getView();let i=t.getModel();if(i.getData().overview.status.external==true){i.setProperty("/overview/status/internal","X")}else{i.setProperty("/overview/status/internal","")}if(i.getData().value.status.external==true){i.setProperty("/value/status/internal","X")}else{i.setProperty("/value/status/internal","")}},onOpenMearsureValueHelp:async function(e){let t=this.getView();let i=this;await this.fetchMearsureSetModel;if(!this._pDialog){this._pDialog=this.loadFragment({name:"desg.view.ValueHelp"}).then(function(e){t.addDependent(e);return e})}this._pDialog.then(function(t){i.setTitleDialog(e,t);t.open()})},onConfirmMearsureValueHelp:function(e){let t=this.getView();let i=e.getSource().getBinding("items");i.filter([]);let l=e.getParameter("selectedContexts");if(l&&l.length){let e=l.map(function(e){return e.getObject()});t.byId(u).setValue(e[0].var_name);let i=t.byId(u).mBindingInfos.value.binding.sPath.replace("external","internal");t.getModel().setProperty(i,e[0].var)}},onOpenOverviewClientValueHelp:async function(e){let t=this.getView();let i=this;await this.fetchClientSetModel();if(!this.pDialog){this.pDialog=this.loadFragment({name:"desg.view.OverviewClientValueHelp"}).then(function(e){t.addDependent(e);return e})}this.pDialog.then(function(t){i.setTitleDialog(e,t);t.open()})},onOpenValueClientValueHelp:async function(e){let t=this.getView();let i=this;await this.fetchClientSetModel();if(!this.qDialog){this.qDialog=this.loadFragment({name:"desg.view.ValueClientValueHelp"}).then(function(e){t.addDependent(e);return e})}this.qDialog.then(function(t){i.setTitleDialog(e,t);t.open()})},onConfirmOverviewClientValueHelp:function(e){let t=this.getView();let i=e.getSource().getBinding("items");i.filter([]);let l=e.getParameter("selectedContexts");if(l&&l.length){let e=l.map(function(e){return e.getObject()});t.getModel().setProperty("/overview/client/internal",e[0].CLIENTKEY);t.getModel().setProperty("/overview/client_item/internal",e[0].CLIENT_ITEM)}},onConfirmValueClientValueHelp:function(e){let t=this.getView();let i=e.getSource().getBinding("items");i.filter([]);let l=e.getParameter("selectedContexts");if(l&&l.length){let e=l.map(function(e){return e.getObject()});t.getModel().setProperty("/value/client/internal",e[0].CLIENTKEY);t.getModel().setProperty("/value/client_item/internal",e[0].CLIENT_ITEM)}},handleMearsureSearch:function(e){let t=e.getParameter("value");let i=new l("var",n.Contains,t);let a=new l("var_name",n.Contains,t);let r=new l([i,a],false);let s=e.getSource().getBinding("items");s.filter(r)},handleClientSearch:function(e){let t=e.getParameter("value");let i=new l("CLIENTKEY",n.Contains,t);let a=new l("TITLE",n.Contains,t);let r=new l("CLIENT_ITEM",n.Contains,t);let s=new l([i,a,r],false);let o=e.getSource().getBinding("items");o.filter(s)},validateEmptyInput:function(){let e=this.getView();let t=this;let i=false;let l=e.getModel().getProperty("/overview");let n=e.getModel().getProperty("/value");let r=["objective1","subjective1","client","client_item","logarithm","rugsub","subjective2","year"];let s=["objective1","subjective1","client","client_item","logarithm","rugsub","pValue","year"];for(let e in l){let n=r.find(t=>t==e);if(n!=undefined){if(e=="client_item"&&l[e].internal==""||e=="year"&&l[e].internal==""||e=="client"&&l[e].external==""||l[e].external==""){t.setStateError("overview",e,"error");a.show("Please input all fields on screen");i=true}else{t.setStateError("overview",e,"None")}if(e=="logarithm"){let l=t.byId("input_overview_logarithm").getSelectedKey();if(l==""){t.setStateError("overview",e,"error");a.show("Please input all fields on screen");i=true}else{t.setStateError("overview",e,"None")}}}}for(let e in n){let l=s.find(t=>t==e);if(l!=undefined){if(e=="year"&&n[e].internal==""||e=="client"&&n[e].external==""||e=="pValue"&&n[e].internal==""||n[e].external==""){t.setStateError("value",e,"error");a.show("Please input all fields on screen");i=true}else{t.setStateError("value",e,"None")}if(e=="logarithm"){let l=t.byId("input_value_logarithm").getSelectedKey();if(l==""){t.setStateError("value",e,"error");a.show("Please input all fields on screen");i=true}else{t.setStateError("value",e,"None")}}}}return i},validateValueNumber:function(){let e=this.getView().getModel().getProperty("/overview/year/internal");let t=this.getView().getModel().getProperty("/value/year/internal");let i=false;if(parseInt(e)>99||parseInt(e)<1){a.show("Please enter value of year from 1 to 99");i=true}else{i=false}if(parseInt(t)>99||parseInt(t)<1){a.show("Please enter value of year from 1 to 99");i=true}else{i=false}return i},setStateError:function(e,t,i){if(i=="error"){this.getView().getModel().setProperty(`/${e}/${t}/state`,"Error")}else{this.getView().getModel().setProperty(`/${e}/${t}/state`,"None")}},setStructureDataBeforeUpdate:function(){let e=[];let t=this.getView();let i=t.getModel().getData();let l=t.byId("input_overview_logarithm").getSelectedKey();let n=t.byId("input_value_logarithm").getSelectedKey();e=[{category:"2",usage_flag:i.overview.status.internal,objective1:i.overview.objective1.internal,objective2:"",subjective1:i.overview.subjective1.internal,logarithm:l,rugsub:i.overview.rugsub.internal,subjective2:i.overview.subjective2.internal,client:i.overview.client.internal,client_item:i.overview.client_item.internal,pValue:null,year:parseInt(i.overview.year.internal)},{category:"1",usage_flag:i.value.status.internal,objective1:i.value.objective1.internal,objective2:i.value.objective2.internal,subjective1:i.value.subjective1.internal,logarithm:n,rugsub:i.value.rugsub.internal,subjective2:"",client:i.value.client.internal,client_item:i.value.client_item.internal,pValue:parseFloat(i.value.pValue.internal),year:parseInt(i.value.year.internal)}];return e},onUpdatePress:async function(e){let t=this;let i=this.validateEmptyInput();if(i==false){let e=t.validateValueNumber();if(e==false){let e=t.validateClient();if(e==true){t.updateParam([])}}}},updateParam:async function(e){let t=this.setStructureDataBeforeUpdate();let i=await s.upsertParameter(t,e);if(i.error){if(i.error.code=="400"){a.show("Update Successfully!")}else{a.show("Update no success, please check again!")}}else{a.show("Update Successfully!")}},onShowConfirmMessageBox:function(e,t,i){o.confirm(t,{title:e,actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:i})},fetchClientSetModel:async function(){let e=await s.getClient();if(e.error){console.log(e.error)}else{e=e.value;let i=e;let l=e.filter(e=>e.MATRIX=="O");let n=e.filter(e=>e.CHART=="O");let a={data:l};let r={data:n};let s={data:i};let o=new t(a);this.getView().setModel(o,"overviewClient");let u=new t(r);this.getView().setModel(u,"valueClient");let g=new t(s);this.getView().setModel(g,"allClient")}},fetchMearsureSetModel:async function(){let e=await s.getMeasureMaster();let i=[];if(e.error){console.log(e.error)}else{i=e.value;let l={data:i};let n=new t(l);this.getView().setModel(n,"mearsureData")}},validateClient:function(){const e=this.getView().getModel();const t=this;const i=e.getProperty("/overview/client/internal");const l=e.getProperty("/overview/client_item/internal");const n=e.getProperty("/value/client/internal");this.fetchClientSetModel();const a=this.getView().getModel("allClient").getProperty("/data");const r=this.getView().getModel("allClient").getProperty("/data");this.aNewClient=[];const s=a.find(e=>e.CLIENTKEY==i);const o=a.find(e=>e.CLIENT_ITEM==l);const u=r.find(e=>e.CLIENTKEY==n);if(s&&o&&u){return true}else{const a="Confirm";let r="Are you sure to create new client: ";let g;if(u){r+=`${i} - ${l}`;g=function(n){if(n=="YES"){this.aNewClient.push({CLIENTKEY:i,CLIENT_ITEM:l,TITLE:i});if(s==undefined){e.setProperty("/overview/client/internal",i)}t.updateParam(this.aNewClient)}else{this.aNewClient=undefined}}.bind(this)}else if(s&&o){r+=`${n} - TESTING`;g=function(i){if(i=="YES"){this.aNewClient.push({CLIENTKEY:n,CLIENT_ITEM:"TESTING",TITLE:n});e.setProperty("/value/client_item/internal","TESTING");e.setProperty("/value/client/internal",n);t.updateParam(this.aNewClient)}else{this.aNewClient=undefined}}.bind(this)}else if(i==n){r+=`${i} - ${l}`;g=function(a){if(a=="YES"){this.aNewClient.push({CLIENTKEY:i,CLIENT_ITEM:l,TITLE:i});let a=e.getProperty("/overview/client_item/internal");e.setProperty("/overview/client/internal",i);e.setProperty("/value/client_item/internal",a);e.setProperty("/value/client/internal",n);t.updateParam(this.aNewClient)}else{this.aNewClient=undefined}}.bind(this)}else{r+=`${i} - ${l} and ${n} - TESTING`;g=function(a){if(a=="YES"){this.aNewClient.push({CLIENTKEY:i,CLIENT_ITEM:l,TITLE:i});this.aNewClient.push({CLIENTKEY:n,CLIENT_ITEM:"TESTING",TITLE:n});e.setProperty("/overview/client/internal",i);e.setProperty("/value/client/internal",n);e.setProperty("/value/client_item/internal","TESTING");t.updateParam(this.aNewClient)}else{this.aNewClient=undefined}}.bind(this)}this.onShowConfirmMessageBox(a,r,g);console.log(this.aNewClient);return false}},setModelLogarithm:function(){let e={value:[{key:1,text:"Yes"},{key:0,text:"No"}]};const i=new t(e);this.getView().setModel(i,"logarithmCollections")},setModelInputField:function(){let e={overview:{status:{internal:"",external:false,state:"None"},objective1:{internal:"",external:"",state:"None"},objective2:{internal:"",external:"",state:"None"},subjective1:{internal:"",external:"",state:"None"},logarithm:{state:"None"},rugsub:{internal:"",external:"",state:"None"},subjective2:{internal:"",external:"",state:"None"},client:{internal:"",state:"None"},client_item:{internal:""},pValue:{internal:"",state:"None"},year:{internal:"",state:"None"}},value:{status:{internal:"",external:false,state:"None"},objective1:{internal:"",external:"",state:"None"},objective2:{internal:"",external:"",state:"None"},subjective1:{internal:"",external:"",state:"None"},logarithm:{state:"None"},rugsub:{internal:"",external:"",state:"None"},subjective2:{internal:"",external:"",state:"None"},client:{internal:"",state:"None"},client_item:{internal:""},pValue:{internal:"",state:"None"},year:{internal:"",state:"None"}}};const i=new t(e);this.getView().setModel(i)},getIdInputClicked:function(e){u=e.getParameters().id;let t=u.replace("container-desg---Main--","").split("_");return t},setTitleDialog:function(e,t){let i=this.getIdInputClicked(e);let l="";if(i.length>3){l=`title_${i[2]}_${i[3]}`}else{l="title_"+i[2]}let n=document.getElementById("container-desg---Main--"+l);t.setTitle(n.innerText)}})});